var Phantom = require('../illusion/phantom');

describe('Phantom specs', function() {
    var phantom = new Phantom();

    beforeEach(function(done) {
        phantom.open(done);
    });

    it('should support get version', function(done) {
        phantom.getVersion(function(err, version) {
            expect(version.major).toEqual(1);
            expect(version.minor).toEqual(9);
            done();
        });
    });

    it('should support enable/disable cookies', function(done) {
        phantom.enableCookies(function() {
            phantom.isCookiesEnabled(function(err, result) {
                expect(result).toBe(true);
                phantom.disableCookies(function() {
                    phantom.isCookiesEnabled(function(err, result) {
                        expect(result).toBe(false);
                        done();
                    });
                });
            });
        });
    });

    it('should support add/remove/get cookie', function(done) {
        var cookie = {
            name: 'cookiename',
            value: 'cookievalue',
            domain: '.domain.com'
        };
        phantom.addCookies(cookie, function() {
            phantom.getCookies(function(err, cookies) {
                expect(cookies.length).toEqual(1);
                var cookie = cookies[0];
                expect(cookie.name).toEqual('cookiename');
                expect(cookie.value).toEqual('cookievalue');
                expect(cookie.domain).toEqual('.domain.com');
                phantom.removeCookies('cookiename', function() {
                    phantom.getCookies(function(err, cookies) {
                        expect(cookies.length).toEqual(0);
                        done();
                    });
                });
            });
        });
    });

    it('should support add/remove/get/clear cookies', function(done) {
        var cookie = {
            name: 'cookiename',
            value: 'cookievalue',
            domain: '.domain.com'
        };
        var cookie2 = {
            name: 'cookiename2',
            value: 'cookievalue2',
            domain: '.domain2.com'
        };
        var cookie3 = {
            name: 'cookiename3',
            value: 'cookievalue3',
            domain: '.domain3.com'
        };
        phantom.addCookies([ cookie, cookie2, cookie3 ], function() {
            phantom.getCookies(function(err, cookies) {
                expect(cookies.length).toEqual(3);
                phantom.removeCookies([ 'cookiename', 'cookiename2' ], function() {
                    phantom.getCookies(function(err, cookies) {
                        expect(cookies.length).toEqual(1);
                        phantom.clearCookies(function() {
                            phantom.getCookies(function(err, cookies) {
                                expect(cookies.length).toEqual(0);
                                done();
                            });
                        });
                    });
                });
            });
        });
    });

    it('should set/get library path and inject JS', function(done) {
        phantom.getLibraryPath(function(err, path) {
            expect(path).toContain('/phantom');
            path = path.replace(/phantom$/, 'public');
            phantom.setLibraryPath(path, function() {
                phantom.getLibraryPath(function(err, newPath) {
                    expect(newPath).toEqual(path);
                    phantom.injectJS('test.js', function(err, result) {
                        expect(result).toBe(true);
                        done();
                    });
                });
            });
        });
    });

    afterEach(function(done) {
        phantom.close(done);
    });
});
var TestServer = require('../utility/testserver');
var Phantom = require('../illusion/phantom');
var WebPage = require('../illusion/webpage');

describe('WebPageCallback specs', function() {
    var testServer = new TestServer();
    var phantom = new Phantom();
    var webPage;

    beforeEach(function(done) {
        testServer.start(1130, function() {
            phantom.open(function() {
                webPage = phantom.createWebPage(done);
            });
        });
    });

    it('should support navigation requested callback', function(done) {
        webPage.on('Page.NavigationRequested', function() {
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html');
    });

    it('should support URL changed callback', function(done) {
        webPage.on('Page.URLChanged', function(targetURL) {
            expect(targetURL).toEqual('http://localhost:1130/test.html');
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html');
    });

    it('should support load started callback', function(done) {
        webPage.on('Page.LoadStarted', function() {
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html');
    });

    it('should support load finished callback', function(done) {
        webPage.on('Page.LoadFinished', function() {
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html');
    });

    it('should support initialized callback', function(done) {
        webPage.on('Page.Initialized', function() {
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html');
    });

    it('should support closing callback', function(done) {
        webPage.on('Page.Closing', function() {
            done();
        });
        webPage.open('http://localhost:1130/test.html', function() {
            webPage.close();
        });
    });

    it('should support console message callback', function(done) {
        webPage.on('Page.ConsoleMessage', function(msg) {
            expect(msg).toEqual('console_message');
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html', function() {
            webPage.evaluate(function() {
                console.log('console_message');
            });
        });
    });

    it('should support error callback', function(done) {
        webPage.on('Page.Error', function(msg, trace) {
            expect(msg).toEqual('SyntaxError: Parse error');
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html', function() {
            webPage.evaluateAsync('function(){for(;)}');
        });
    });

    it('should support alert callback', function(done) {
        webPage.on('Page.Alert', function(msg) {
            expect(msg).toEqual('alert_message');
            webPage.close(done);
        });
        webPage.open('http://localhost:1130/test.html', function() {
            webPage.evaluate(function() {
                window.alert('alert_message');
            });
        });
    });

    afterEach(function(done) {
        phantom.close(function() {
            testServer.stop();
            done();
        });
    });
});